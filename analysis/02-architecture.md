# Architecture Analysis

## Package Structure Overview

```
njschooldata/
├── R/                      # 29 R files, ~8,300 LOC
├── data-raw/               # Source data for internal datasets
├── man/                    # 176 Rd documentation files
├── tests/
│   └── testthat/           # 17 test files
├── DESCRIPTION
├── NAMESPACE               # 155 exports
├── .travis.yml             # Deprecated CI
└── .github/
    └── lint.yaml           # Linting configuration
```

## Adherence to R Package Conventions

### Compliant
- [x] DESCRIPTION with required fields
- [x] NAMESPACE generated by roxygen2
- [x] R/ directory for source code
- [x] man/ directory for documentation
- [x] tests/testthat/ for testing
- [x] LazyData: true for efficient data loading

### Non-Compliant or Missing
- [ ] No vignettes/ directory (long-form documentation)
- [ ] No inst/ directory (additional files)
- [ ] .travis.yml is deprecated (should use GitHub Actions)
- [ ] No pkgdown configuration (_pkgdown.yml)
- [ ] No .Rbuildignore (may include unnecessary files)
- [ ] Date field in DESCRIPTION is 2015 (outdated)

## Separation of Concerns Analysis

### Current Architecture

The package has an implicit 3-tier architecture:

```
┌─────────────────────────────────────────────────────────┐
│                    USER-FACING API                       │
│  fetch_enr(), fetch_parcc(), fetch_grad_rate(), etc.    │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────┐
│                   PROCESSING LAYER                       │
│  process_enr(), process_parcc(), tidy_*, clean_*        │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────┐
│                   DATA ACCESS LAYER                      │
│  get_raw_enr(), get_raw_parcc(), downloader::download() │
└─────────────────────────────────────────────────────────┘
```

### Issues with Current Architecture

1. **Mixed Concerns in Files**
   - `enr.R` contains both data fetching AND processing logic
   - `grate.R` mixes URL construction, downloading, and data transformation
   - `parcc.R` combines API calls with data cleaning

2. **No Clear Module Boundaries**
   - Functions are grouped by data type (enrollment, assessment, graduation)
   - But each file handles the full pipeline from fetch to output

3. **Configuration Embedded in Code**
   - URL patterns hardcoded in functions
   - Year-specific logic scattered throughout
   - No centralized configuration

## Proposed Improved Architecture

```
R/
├── config/
│   ├── urls.R              # URL templates and patterns
│   ├── years.R             # Valid year ranges per data type
│   └── constants.R         # Magic numbers, codes
│
├── fetch/
│   ├── download.R          # Generic download utilities
│   ├── fetch_enrollment.R  # Enrollment data fetching
│   ├── fetch_assessment.R  # Assessment data fetching
│   └── fetch_graduation.R  # Graduation data fetching
│
├── process/
│   ├── clean_names.R       # Name normalization
│   ├── process_enrollment.R
│   ├── process_assessment.R
│   └── process_graduation.R
│
├── aggregate/
│   ├── sector_aggs.R       # Generic aggregation factory
│   ├── enrollment_aggs.R
│   └── graduation_aggs.R
│
├── api/                    # User-facing functions
│   ├── enrollment.R        # fetch_enr(), tidy_enr()
│   ├── assessment.R        # fetch_parcc(), fetch_njask()
│   └── graduation.R        # fetch_grad_rate(), fetch_grad_count()
│
└── utils/
    ├── validation.R        # Input validation
    ├── padding.R           # String padding utilities
    └── percentile.R        # Statistical helpers
```

## Internal vs Exported Function Organization

### Current State

**Exported (NAMESPACE)**: 155 functions
**Internal (not exported)**: ~20 functions

### Problems
1. Many internal helper functions are exported unnecessarily:
   - `trim_whitespace()` - generic utility
   - `pad_grade()` - internal helper
   - `clean_cds_fields()` - internal processing
   - `rc_numeric_cleaner()` - very specific helper

2. Some functions that should be internal are exported:
   - `common_fwf_req()` - technical implementation detail
   - `nj_coltype_parser()` - internal parsing

### Recommended Export Strategy

**Core API (15-20 functions)**:
- `fetch_enr()`, `fetch_parcc()`, `fetch_grad_rate()`, `fetch_grad_count()`
- `fetch_njask()`, `fetch_hspa()`, `fetch_gepa()` (legacy assessments)
- `fetch_sped()`, `fetch_msgp()`, `fetch_tges()`
- `get_school_directory()`, `get_district_directory()`
- `get_essa_file()`, `get_rc_databases()`

**Tidy/Transform (10-15 functions)**:
- `tidy_enr()`, `tidy_parcc_subgroup()`, `tidy_grad_rate()`

**Aggregation (10-15 functions)**:
- `*_sector_*_aggs()` family
- `*_allpublic_*_aggs()` family

**Internalize**:
- All `process_*()` functions (implementation details)
- All `clean_*()` functions (internal processing)
- All `get_raw_*()` functions (use fetch_* instead)
- Utility functions like `pad_leading()`, `trim_whitespace()`

## Circular Dependencies

No circular dependencies detected between R files. The dependency graph is generally:

```
util.R ─────────────────────────────────────────────────┐
   │                                                     │
   └──▶ layout_data.R ──▶ fetch_nj_assess.R ──▶ njask.R │
                │                                        │
                └──▶ hspa.R, gepa.R                      │
                                                         │
lookups.R ─────────────────────────────────────────────▶ enr.R
                                                         │
charter.R ◀──────────────────────────────────────────────┘
   │
   └──▶ geo.R
```

## Cohesion Analysis

### High Cohesion (Good)
- `util.R` - Generic utilities, well-focused
- `dfg.R` - Single responsibility (DFG lookup)
- `directory.R` - Clear purpose (school/district directories)
- `essa.R` - Single data source handling

### Low Cohesion (Needs Improvement)
- `enr.R` (1,115 lines) - Does too much:
  - Raw data fetching
  - Name cleaning
  - Data type conversion
  - Aggregation
  - Tidying

- `grate.R` (980 lines) - Mixed responsibilities:
  - Graduation rate fetching
  - Graduation count fetching
  - Multiple processing paths
  - Aggregation identification

### Recommended File Splits

**enr.R should become**:
- `fetch_enrollment.R` - `get_raw_enr()`, `fetch_enr()`
- `process_enrollment.R` - `process_enr()`, `clean_enr_*()`, `split_enr_cols()`
- `tidy_enrollment.R` - `tidy_enr()`, `id_enr_aggs()`, `enr_grade_aggs()`
- `enrollment_names.R` - Name mappings and cleaning

**grate.R should become**:
- `fetch_graduation.R` - `get_raw_grad_file()`, `get_grad_count()`, `get_grad_rate()`
- `process_graduation.R` - `process_grate()`, `process_grad_count()`, `process_grad_rate()`
- `tidy_graduation.R` - `tidy_grad_rate()`, `tidy_grad_count()`
- `graduation_aggs.R` - `id_grad_aggs()`, `enrich_grad_count()`

## API Design Consistency

### Current Inconsistencies

| Pattern | Examples | Issue |
|---------|----------|-------|
| `fetch_*()` | `fetch_enr()`, `fetch_parcc()` | Good, consistent |
| `get_*()` | `get_raw_enr()`, `get_grad_rate()` | Inconsistent with fetch_ |
| `tidy_*()` | `tidy_enr()`, `tidy_grad_rate()` | Good |
| `process_*()` | `process_enr()`, `process_grate()` | Should be internal |

### Parameter Inconsistencies

```r
# end_year is first param in most functions
fetch_enr(end_year, tidy=FALSE)
fetch_parcc(end_year, grade_or_subj, subj, tidy=FALSE)
fetch_grad_rate(end_year, methodology='4 year')

# But get_* functions vary
get_raw_enr(end_year)
get_grad_rate(end_year, methodology)  # methodology required, no default
```

### Recommended API Design

```r
# All fetch_* functions should have consistent signature:
fetch_enr(end_year, tidy = FALSE, ...)
fetch_assessment(end_year, grade = NULL, subject = NULL, type = "njsla", tidy = FALSE)
fetch_graduation(end_year, type = "rate", methodology = "4 year", tidy = FALSE)
```

## Configuration Management

### Current State: Hardcoded Values

```r
# URLs scattered in multiple files
"https://www.nj.gov/education/doedata/enr/"
"https://www.nj.gov/education/assessment/results/reports/"
"https://www.state.nj.us/education/data/grd/"
"https://homeroom4.doe.state.nj.us/public/"
```

### Recommended Configuration Approach

Create `R/config.R`:
```r
#' NJ DOE Data Configuration
#' @keywords internal
nj_config <- list(
  base_urls = list(
    enrollment = "https://www.nj.gov/education/doedata/enr/",
    assessment = "https://www.nj.gov/education/assessment/results/reports/",
    graduation = "https://www.nj.gov/education/schoolperformance/grad/data/",
    directory = "https://homeroom4.doe.state.nj.us/public/"
  ),

  valid_years = list(
    enrollment = 1999:2025,
    parcc = 2015:2018,
    njsla = 2019:2025,
    graduation_rate = 2011:2024,
    graduation_count = 1998:2024
  ),

  school_codes = list(
    district_total = "999",
    state_district = "9999",
    state_county = "99",
    charter_county = "80"
  )
)
```

## Summary of Architectural Issues

| Issue | Severity | Files Affected |
|-------|----------|----------------|
| No vignettes | Medium | Package-wide |
| Mixed concerns in files | High | enr.R, grate.R, parcc.R |
| Too many exports | Medium | NAMESPACE |
| Hardcoded configuration | High | Most R files |
| Inconsistent API design | Medium | fetch_*, get_* functions |
| No input validation layer | High | All exported functions |
| Missing error handling | High | Download functions |

## Recommended Actions

1. **Immediate**: Create configuration file for URLs and valid years
2. **High Priority**: Add input validation to all exported functions
3. **Medium Priority**: Split large files (enr.R, grate.R) by responsibility
4. **Medium Priority**: Reduce exports, internalize implementation details
5. **Low Priority**: Create vignettes for main use cases
6. **Low Priority**: Standardize API patterns across all fetch_* functions
